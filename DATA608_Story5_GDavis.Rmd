---
title: "DATA608 - Story5"
author: "Glen Dale Davis"
date: "2023-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages:

```{r packages, warning = FALSE, message = FALSE}
library(tidyverse)
library(zoo)

```

## Data:

### Temperature:

```{r temperature}
my_url1 <- "https://github.com/geedoubledee/data608_story5/raw/main/data/global_land_ocean_temp_index.csv"
temperature_df <- read.csv(my_url1, skip = 1)
temperature_df <- temperature_df |>
    filter(Year >= 1980)

```

### Tornadoes:

```{r tornadoes}
my_url2 <- "https://github.com/geedoubledee/data608_story5/raw/main/data/1950-2022_actual_tornadoes.csv"
tornadoes_df <- read.csv(my_url2, skip = 2)

```

```{r tornadoes_summaries}
mil <- 1000000
tornadoes_before_1996 <- tornadoes_df |>
    filter(yr < 1996) |>
    mutate(loss = case_when(
        loss < 1 ~ 0,
        loss < 2 ~ 50 / mil,
        loss < 3 ~ 275 / mil,
        loss < 4 ~ 2750 / mil,
        loss < 5 ~ 27500 / mil,
        loss < 6 ~ 275000 / mil,
        loss < 7 ~ 2750000 / mil,
        loss < 8 ~ 27500000 / mil,
        loss < 9 ~ 275000000 / mil))
tornadoes_df <- tornadoes_df |>
    filter(yr >= 1996) |>
    bind_rows(tornadoes_before_1996)
tornadoes_state_summary_df <- tornadoes_df |>
    filter(sn == 1) |>
    group_by(st, yr) |>
    summarize(Injuries_Sum = sum(inj),
              Fatalities_Sum = sum(fat),
              Property_Loss_Sum = sum(loss) * mil,
              Count = n())
tornadoes_national_summary_df <- tornadoes_state_summary_df |>
    group_by(yr) |>
    summarize(Total_Injuries = sum(Injuries_Sum),
           Total_Fatalities = sum(Fatalities_Sum),
           Total_Property_Loss = sum(Property_Loss_Sum),
           Total_Count = sum(Count))

```

```{r tornadoes_rolling_average}
tornadoes_national_summary_df <- tornadoes_national_summary_df |>
    arrange(desc(yr)) |>
    mutate(Injuries_30YrAvg = round(zoo::rollmean(Total_Injuries, k = 30,
                                                  fill = NA,
                                                  align = "left"), 0),
           Fatalities_30YrAvg = round(zoo::rollmean(Total_Fatalities, k = 30,
                                                    fill = NA,
                                                    align = "left"), 0),
           Property_Loss_30YrAvg = zoo::rollmean(Total_Property_Loss,
                                                       k = 30, fill = NA,
                                                       align = "left"),
           Count_30YrAvg = round(zoo::rollmean(Total_Count, k = 30,
                                               fill = NA, align = "left"), 0))

```

```{r tornadoes_anomalies}
tornadoes_national_summary_df <- tornadoes_national_summary_df |>
    mutate(Injuries_Diff = Total_Injuries - Injuries_30YrAvg,
           Fatalities_Diff = Total_Fatalities - Fatalities_30YrAvg,
           Property_Loss_Diff = Total_Property_Loss - Property_Loss_30YrAvg,
           Count_Diff = Total_Count - Count_30YrAvg)

```

### Hurricanes/Typhoons:

```{r hurricanes_typhoons}
my_url3 <- "https://github.com/geedoubledee/data608_story5/raw/main/data/ibtracs.EP.list.v04r00_since1950.csv"
my_url4 <- "https://github.com/geedoubledee/data608_story5/raw/main/data/ibtracs.NA.list.v04r00_since1950.csv"
my_url5 <- "https://github.com/geedoubledee/data608_story5/raw/main/data/ibtracs.NI.list.v04r00_since1950.csv"
my_url6 <- "https://github.com/geedoubledee/data608_story5/raw/main/data/ibtracs.SA.list.v04r00_since1950.csv"
my_url7 <- "https://github.com/geedoubledee/data608_story5/raw/main/data/ibtracs.SI.list.v04r00_since1950.csv"
my_url8 <- "https://github.com/geedoubledee/data608_story5/raw/main/data/ibtracs.SP.list.v04r00_since1950.csv"
my_url9 <- "https://github.com/geedoubledee/data608_story5/raw/main/data/ibtracs.WP.list.v04r00_since1950.csv"
hurr_typh_EP_df <- read.csv(my_url3, na.strings = c())
hurr_typh_NA_df <- read.csv(my_url4, na.strings = c())
hurr_typh_NI_df <- read.csv(my_url5, na.strings = c())
hurr_typh_SA_df <- read.csv(my_url6, na.strings = c())
hurr_typh_SI_df <- read.csv(my_url7, na.strings = c())
hurr_typh_SP_df <- read.csv(my_url8, na.strings = c())
hurr_typh_WP_df <- read.csv(my_url9, na.strings = c())
hurr_typh_df_list <- list(hurr_typh_EP_df, hurr_typh_NA_df, hurr_typh_NI_df,
                          hurr_typh_SA_df, hurr_typh_SI_df, hurr_typh_SP_df,
                          hurr_typh_WP_df)
col_not_all_na <- function(x){
    any(!is.na(x))
}
copy <- hurr_typh_df_list
for (i in 1:length(copy)){
    hurr_typh_df_list[[i]] <- hurr_typh_df_list[[i]] |>
        select(where(col_not_all_na)) |>
        filter(SEASON < 2023)
}
rm(copy, hurr_typh_EP_df, hurr_typh_NA_df, hurr_typh_NI_df, hurr_typh_SA_df,
   hurr_typh_SI_df, hurr_typh_SP_df, hurr_typh_WP_df)

```

```{r hurricanes_typhoons_levels}
#Look through the various columns that indicate a storm is hurricane/typhoon level
col_names <- c("USA_STATUS", "TOKYO_GRADE", "CMA_CAT", "HKO_CAT",
               "NEWDELHI_GRADE", "REUNION_TYPE", "BOM_TYPE", "NADI_CAT",
               "TD9636_STAGE", "MLC_CLASS")
usa_status <- c("TY", "ST", "HU", "HR")
tokyo_grade <- 5 #Typhoon (TY)
cma_cat <- c(4, 5, 6) #Typhoon, Severe Typhoon, & Super Typhoon
hko_cat <- c("T", "ST", "SuperT") #Typhoon, Severe Typhoon, & Super Typhoon
newdelhi_grade <- c("VSCS", "SCS") #Very Severe Cyclonic Storm, equivalent to Typhoon, & Super Cyclonic Storm, equivalent to Severe and Super Typhoons
reunion_type <- 4 #Equivalent to Typhoon
bom_type <- 40 #Equivalent to Typhoon
nadi_cat <- c(3, 4, 5) #Typhoon & Up
td9636_stage <- 4 #Hurricane
mlc_class <- "HU" #Hurricane
col_levels <- list(usa_status, tokyo_grade, cma_cat, hko_cat, newdelhi_grade,
                   reunion_type, bom_type, nadi_cat, td9636_stage, mlc_class)
names(col_levels) <- col_names
copy <- hurr_typh_df_list
for (i in 1:length(copy)){
    df_old <- hurr_typh_df_list[[i]]
    df_new <- df_old[c(), ]
    for (j in 1:length(col_levels)){
        col_name <- names(col_levels[j])
        df_cols <- colnames(df_old)
        if (!col_name %in% df_cols){
            next
        }else{
            df_sub <- df_old |>
                filter(!!as.symbol(col_name) %in% col_levels[[j]])
            if (nrow(df_sub) > 0){
                df_new <- df_new |>
                    bind_rows(df_sub)
            }else{
                next
            }
        }
    }
    hurr_typh_df_list[[i]] <- df_new
}
rm(copy, df_old, df_sub, df_new)

```

```{r hurricanes_typhoons_counts}
#Count unique hurricane/typhoon-level storms per season
hurr_typh_unique_df <- as.data.frame(matrix(nrow = 0, ncol = 4))
cols <- c("BASIN", "SEASON", "SID", "NAME")
colnames(hurr_typh_unique_df) <- cols
hurr_typh_unique_df[] <- lapply(hurr_typh_unique_df, as.character)
hurr_typh_unique_df$SEASON <- as.integer(hurr_typh_unique_df$SEASON)
for (i in 1:length(hurr_typh_df_list)){
    current <- hurr_typh_df_list[[i]] |>
        select(all_of(cols))
    hurr_typh_unique_df <- hurr_typh_unique_df |>
        bind_rows(current) |>
        distinct()
}
hurr_typh_counts_df <- hurr_typh_unique_df |>
    distinct(SID, .keep_all = TRUE) |>
    group_by(SEASON) |>
    summarize(Count = n())
colnames(hurr_typh_counts_df) <- c("Year", "Count")

```

## Visualizations:
